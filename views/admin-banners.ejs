<%- include('partials/admin-header', { page: 'banners' }) %>

<main class="admin-container">
    <div class="admin-header">
        <h2>Gerenciar Banners</h2>
        
        <div class="header-actions">
            <input type="text" id="buscaAdmin" class="header-busca" placeholder="üîç Buscar banner...">
            <button onclick="abrirModal()" class="btn btn-enviar">+ Novo Banner</button>
        </div>
    </div>

    <div class="tabela-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Imagem</th>
                    <th>T√≠tulo / Cliente</th>
                    <th>Link</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>
</main>

<div id="modalBanner" class="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Novo Banner</h3>
        
        <form id="formBanner" enctype="multipart/form-data">
            <input type="hidden" id="bannerId" name="id">
            
            <label>T√≠tulo / Cliente:</label>
            <input type="text" id="titulo" name="titulo" required placeholder="Ex: Promo√ß√£o Pizzaria">

            <label>Link de Destino:</label>
            <input type="text" id="link" name="link" placeholder="https://...">

            <label>Imagem:</label>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <input type="file" id="imagemInput" name="imagem" accept="image/*" style="width: 100%;">
                
                <input type="hidden" id="imagemUrl" name="imagemUrl">
                
                <img id="previewImagem" src="" style="max-height: 100px; display: none; margin-top: 10px; border-radius: 4px;">
            </div>

            <div class="modal-buttons">
                <button type="button" onclick="fecharModal()" class="btn btn-cancelar">Cancelar</button>
                <button type="submit" class="btn btn-enviar">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('modalBanner');
    const form = document.getElementById('formBanner');
    const inputBusca = document.getElementById('buscaAdmin');

    async function carregar() {
        const res = await fetch('/api/banners');
        const banners = await res.json();
        const tbody = document.getElementById('tabelaCorpo');
        tbody.innerHTML = '';

        banners.forEach(b => {
            tbody.innerHTML += `
                <tr>
                    <td>${b.id}</td>
                    <td><img src="${b.imagem}" style="width:80px; height:auto; border-radius:4px;"></td>
                    <td>${b.titulo}</td>
                    <td><a href="${b.link}" target="_blank" style="color:var(--cor-primaria);">Link üîó</a></td>
                    <td>
                        <button onclick='editar(${JSON.stringify(b)})' class="btn-acao editar">‚úèÔ∏è</button>
                        <button onclick="deletar(${b.id})" class="btn-acao deletar">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('bannerId').value;
        const metodo = id ? 'PUT' : 'POST'; // Define se cria ou edita
        const url = id ? `/api/banners/${id}` : '/api/banners';

        const formData = new FormData(form);
        const res = await fetch(url, { method: metodo, body: formData });

        if (res.ok) { fecharModal(); carregar(); } 
        else { alert('Erro ao salvar.'); }
    });

    // Fun√ß√£o de Editar (Preenche o modal)
    window.editar = function(b) {
        document.getElementById('modalTitulo').innerText = 'Editar Banner';
        document.getElementById('bannerId').value = b.id;
        document.getElementById('titulo').value = b.titulo;
        document.getElementById('link').value = b.link;
        
        document.getElementById('imagemUrl').value = b.imagem;
        const preview = document.getElementById('previewImagem');
        if(b.imagem) { preview.src = b.imagem; preview.style.display = 'block'; }
        
        document.getElementById('imagemInput').value = ''; // Limpa sele√ß√£o de arquivo novo
        modal.style.display = 'flex';
    };

    window.deletar = async function(id) {
        if(confirm('Apagar banner?')) {
            await fetch(`/api/banners/${id}`, { method: 'DELETE' });
            carregar();
        }
    };

    // Busca R√°pida
    inputBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.querySelectorAll('#tabelaCorpo tr').forEach(linha => {
            linha.style.display = linha.innerText.toLowerCase().includes(termo) ? '' : 'none';
        });
    });

    document.getElementById('imagemInput').onchange = evt => {
        const [file] = evt.target.files;
        if (file) {
            const preview = document.getElementById('previewImagem');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    };

    window.abrirModal = () => {
        form.reset();
        document.getElementById('bannerId').value = '';
        document.getElementById('modalTitulo').innerText = 'Novo Banner';
        document.getElementById('previewImagem').style.display = 'none';
        modal.style.display = 'flex';
    };
    window.fecharModal = () => modal.style.display = 'none';

    carregar();
</script>
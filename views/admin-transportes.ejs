<%- include('partials/admin-header', { page: 'transportes' }) %>

<main class="admin-container">
    <div class="form-card">
        <h3 id="formTitulo">Novo Transporte</h3>
        <form id="formTransporte">
            <input type="hidden" id="id">
            
            <label>Nome da Empresa/Motorista:</label>
            <input type="text" id="nome" required>

            <label>Tipo:</label>
            <select id="tipo">
                <option value="onibus">√înibus</option>
                <option value="van">Van</option>
                <option value="mototaxi">Moto T√°xi</option>
            </select>

            <label>Rota (Ex: Teresina -> Pedro II):</label>
            <input type="text" id="rota" required>

            <label>Hor√°rios:</label>
            <input type="text" id="horarios" placeholder="Ex: 07:00, 14:00" required>

            <label>Contato:</label>
            <input type="text" id="contato" required>

            <button type="submit" class="btn btn-enviar" style="width: 100%; margin-top: 1rem;">Salvar</button>
            <button type="button" id="btnCancelar" class="btn btn-cancelar" style="width: 100%; margin-top: 0.5rem; display: none;">Cancelar</button>
        </form>
    </div>

    <div class="lista-card">
        <h3>Transportes Cadastrados</h3>
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Rota</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>
</main>

<script>
    const form = document.getElementById('formTransporte');
    const tabela = document.getElementById('tabelaCorpo');
    const btnCancelar = document.getElementById('btnCancelar');

    async function carregar() {
        const res = await fetch('/api/transportes');
        const lista = await res.json();
        tabela.innerHTML = '';
        lista.forEach(t => {
            let icone = t.tipo === 'onibus' ? 'üöå' : (t.tipo === 'mototaxi' ? 'üèçÔ∏è' : 'üöê');
            tabela.innerHTML += `
                <tr>
                    <td>${icone} ${t.nome}</td>
                    <td>${t.rota}</td>
                    <td>
                        <button class="btn-editar" onclick='editar(${JSON.stringify(t)})'>‚úèÔ∏è</button>
                        <button class="btn-deletar" onclick="deletar(${t.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('id').value;
        const tipo = document.getElementById('tipo').value;
        const dados = {
            nome: document.getElementById('nome').value,
            tipo: tipo,
            rota: document.getElementById('rota').value,
            horarios: document.getElementById('horarios').value,
            contato: document.getElementById('contato').value,
            icone: tipo === 'onibus' ? 'üöå' : (tipo === 'mototaxi' ? 'üèçÔ∏è' : 'üöê')
        };

        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/transportes/${id}` : '/api/transportes';

        const res = await fetch(url, {
            method: metodo,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        });

        if(res.ok) {
            Swal.fire('Sucesso!', 'Transporte salvo.', 'success');
            resetar();
            carregar();
        }
    });

    window.deletar = (id) => {
        Swal.fire({ title: 'Apagar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then(async (res) => {
            if(res.isConfirmed) {
                await fetch(`/api/transportes/${id}`, { method: 'DELETE' });
                carregar();
            }
        });
    };

    window.editar = (t) => {
        document.getElementById('id').value = t.id;
        document.getElementById('nome').value = t.nome;
        document.getElementById('tipo').value = t.tipo;
        document.getElementById('rota').value = t.rota;
        document.getElementById('horarios').value = t.horarios;
        document.getElementById('contato').value = t.contato;
        
        document.getElementById('formTitulo').innerText = 'Editando Transporte';
        btnCancelar.style.display = 'block';
    };

    function resetar() {
        form.reset();
        document.getElementById('id').value = '';
        document.getElementById('formTitulo').innerText = 'Novo Transporte';
        btnCancelar.style.display = 'none';
    }
    btnCancelar.onclick = resetar;

    carregar();
</script>
</body>
</html>
<%- include('partials/admin-header', { page: 'transportes' }) %>

<main class="admin-container">
    <div class="admin-header">
        <h2>Gerenciar Transportes</h2>
        
        <div class="header-actions">
            <input type="text" id="buscaAdmin" class="header-busca" placeholder="ğŸ” Buscar transporte...">
            <button onclick="abrirModal()" class="btn btn-enviar">+ Novo Transporte</button>
        </div>
    </div>

    <div class="tabela-container">
        <table>
            <thead>
                <tr>
                    <th>Ãcone</th>
                    <th>Nome / Empresa</th>
                    <th>Rota</th>
                    <th>HorÃ¡rios</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo">
                </tbody>
        </table>
    </div>
</main>

<div id="modalTransporte" class="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Novo Transporte</h3>
        
        <form id="formTransporte">
            <input type="hidden" id="transporteId">
            
            <label>Nome da Empresa ou Motorista:</label>
            <input type="text" id="nome" required placeholder="Ex: ViaÃ§Ã£o Real">

            <label>Tipo de VeÃ­culo:</label>
            <select id="tipo">
                <option value="onibus">ğŸšŒ Ã”nibus</option>
                <option value="van">ğŸš Van</option>
                <option value="mototaxi">ğŸï¸ Moto TÃ¡xi</option>
            </select>

            <label>Rota:</label>
            <input type="text" id="rota" required placeholder="Ex: Pedro II -> Teresina">

            <label>HorÃ¡rios:</label>
            <input type="text" id="horarios" required placeholder="Ex: 06:00, 14:30">

            <label>Contato / Telefone:</label>
            <input type="text" id="contato" required placeholder="(86) 9...">

            <div class="modal-buttons">
                <button type="button" onclick="fecharModal()" class="btn btn-cancelar">Cancelar</button>
                <button type="submit" class="btn btn-enviar">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
    const modal = document.getElementById('modalTransporte');
    const form = document.getElementById('formTransporte');
    const inputBusca = document.getElementById('buscaAdmin');

    // 1. Carregar Dados
    async function carregar() {
        try {
            const res = await fetch('/api/transportes');
            const lista = await res.json();
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';

            lista.forEach(t => {
                // Define o emoji baseado no tipo
                let icone = t.tipo === 'onibus' ? 'ğŸšŒ' : (t.tipo === 'mototaxi' ? 'ğŸï¸' : 'ğŸš');
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-size: 1.5rem; text-align: center;">${icone}</td>
                        <td><strong>${t.nome}</strong><br><small style="color:#666;">${t.contato}</small></td>
                        <td>${t.rota}</td>
                        <td>${t.horarios}</td>
                        <td>
                            <button onclick='editar(${JSON.stringify(t)})' class="btn-acao editar">âœï¸</button>
                            <button onclick="deletar(${t.id})" class="btn-acao deletar">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error("Erro ao carregar transportes:", error);
        }
    }

    // 2. Salvar (Usa JSON, pois nÃ£o tem upload de foto aqui)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('transporteId').value;
        const tipo = document.getElementById('tipo').value;
        
        const dados = {
            nome: document.getElementById('nome').value,
            tipo: tipo,
            rota: document.getElementById('rota').value,
            horarios: document.getElementById('horarios').value,
            contato: document.getElementById('contato').value,
            // Envia o Ã­cone para salvar no banco
            icone: tipo === 'onibus' ? 'ğŸšŒ' : (tipo === 'mototaxi' ? 'ğŸï¸' : 'ğŸš')
        };

        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/transportes/${id}` : '/api/transportes';

        const res = await fetch(url, {
            method: metodo,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        });

        if (res.ok) {
            fecharModal();
            carregar();
        } else {
            alert('Erro ao salvar transporte.');
        }
    });

    // 3. Editar
    window.editar = function(t) {
        document.getElementById('modalTitulo').innerText = 'Editar Transporte';
        document.getElementById('transporteId').value = t.id;
        document.getElementById('nome').value = t.nome;
        document.getElementById('tipo').value = t.tipo;
        document.getElementById('rota').value = t.rota;
        document.getElementById('horarios').value = t.horarios;
        document.getElementById('contato').value = t.contato;
        
        modal.style.display = 'flex';
    };

    // 4. Deletar
    window.deletar = async function(id) {
        if(confirm('Tem certeza?')) {
            await fetch(`/api/transportes/${id}`, { method: 'DELETE' });
            carregar();
        }
    };

    // 5. Busca RÃ¡pida
    inputBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const linhas = document.querySelectorAll('#tabelaCorpo tr');
        linhas.forEach(linha => {
            linha.style.display = linha.innerText.toLowerCase().includes(termo) ? '' : 'none';
        });
    });

    // FunÃ§Ãµes do Modal
    window.abrirModal = () => {
        form.reset();
        document.getElementById('transporteId').value = '';
        document.getElementById('modalTitulo').innerText = 'Novo Transporte';
        modal.style.display = 'flex';
    };
    window.fecharModal = () => modal.style.display = 'none';

    // Iniciar
    carregar();
</script>
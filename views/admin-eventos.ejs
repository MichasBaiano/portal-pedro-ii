<%- include('partials/admin-header', { page: 'eventos' }) %>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<main class="admin-container">
    <div class="admin-header">
        <h2>Gerenciar Eventos</h2>
        <div class="header-actions">
            <input type="text" id="buscaAdmin" class="header-busca" placeholder="üîç Buscar evento...">
            <button onclick="abrirModal()" class="btn btn-enviar">+ Novo Evento</button>
        </div>
    </div>

    <div class="tabela-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Foto</th>
                    <th>Nome</th>
                    <th>Data</th>
                    <th>Local</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaCorpo"></tbody>
        </table>
    </div>
</main>

<div id="modalEvento" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <h3 id="modalTitulo">Novo Evento</h3>
        
        <form id="formEvento" enctype="multipart/form-data">
            <input type="hidden" id="eventoId" name="id">
            
            <label>Nome do Evento:</label>
            <input type="text" id="nome" name="nome" required>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>Data:</label>
                    <input type="date" id="data" name="data" required>
                </div>
                <div>
                    <label>Categoria:</label>
                    <select id="categoria" name="categoria">
                        <option value="M√∫sica">M√∫sica / Show</option>
                        <option value="Feira">Feira / Exposi√ß√£o</option>
                        <option value="Religioso">Religioso</option>
                        <option value="Esporte">Esporte</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
            </div>

            <label>Local (Nome):</label>
            <input type="text" id="local" name="local" placeholder="Ex: Pra√ßa da Bonelle" required>

            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 15px 0; border: 1px solid #ddd;">
                <label style="color: #d32f2f;">üìç Onde ser√° no mapa?</label>
                <div id="mapaEventos" style="height: 300px; width: 100%; border-radius: 4px; margin-bottom: 10px; z-index: 1;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="lat" name="latitude" placeholder="Lat" readonly style="background: #eee;">
                    <input type="text" id="lng" name="longitude" placeholder="Lng" readonly style="background: #eee;">
                </div>
            </div>
            <label>Imagem:</label>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <input type="file" id="imagemInput" name="imagem" accept="image/*" style="width: 100%;">
                <input type="hidden" id="imagemUrl" name="imagemUrl">
                <img id="previewImagem" src="" style="max-height: 150px; display: none; margin-top: 10px; border-radius: 8px;">
            </div>

            <label>Descri√ß√£o:</label>
            <textarea id="descricao" name="descricao" rows="4"></textarea>

            <div class="modal-buttons">
                <button type="button" onclick="fecharModal()" class="btn btn-cancelar">Cancelar</button>
                <button type="submit" class="btn btn-enviar">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const modal = document.getElementById('modalEvento');
    const form = document.getElementById('formEvento');
    const inputBusca = document.getElementById('buscaAdmin');

    // --- L√ìGICA DO MAPA ---
    let map = null;
    let marker = null;
    const centroPedroII = [-4.4251, -41.4586];

    function iniciarMapa() {
        if (!map) {
            map = L.map('mapaEventos').setView(centroPedroII, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                definirPonto(lat, lng);
            });
        }
        setTimeout(() => { map.invalidateSize(); }, 200);
    }

    function definirPonto(lat, lng) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
    }

    function resetarMapa() {
        if(marker) map.removeLayer(marker);
        marker = null;
        document.getElementById('lat').value = '';
        document.getElementById('lng').value = '';
        if(map) map.setView(centroPedroII, 14);
    }
    // -----------------------

    async function carregar() {
        try {
            const res = await fetch('/api/eventos');
            const eventos = await res.json();
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';

            eventos.forEach(ev => {
                // Formata data sem problema de timezone
                const dataObj = new Date(ev.data);
                const dataFormatada = dataObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });

                tbody.innerHTML += `
                    <tr>
                        <td>${ev.id}</td>
                        <td><img src="${ev.imagem || '/img/placeholder.jpg'}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"></td>
                        <td>${ev.nome}</td>
                        <td>${dataFormatada}</td>
                        <td>${ev.local}</td>
                        <td>
                            <button onclick='editar(${JSON.stringify(ev)})' class="btn-acao editar">‚úèÔ∏è</button>
                            <button onclick="deletar(${ev.id})" class="btn-acao deletar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        } catch (erro) {
            console.error("Erro ao carregar eventos:", erro);
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('eventoId').value;
        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/eventos/${id}` : '/api/eventos';
        const formData = new FormData(form);

        const res = await fetch(url, { method: metodo, body: formData });

        if (res.ok) { fecharModal(); carregar(); } 
        else { alert('Erro ao salvar evento.'); }
    });

    window.editar = function(ev) {
        document.getElementById('modalTitulo').innerText = 'Editar Evento';
        document.getElementById('eventoId').value = ev.id;
        document.getElementById('nome').value = ev.nome;
        document.getElementById('data').value = ev.data.split('T')[0]; // Ajuste para input date
        document.getElementById('local').value = ev.local;
        document.getElementById('categoria').value = ev.categoria;
        document.getElementById('descricao').value = ev.descricao;

        document.getElementById('imagemUrl').value = ev.imagem;
        const preview = document.getElementById('previewImagem');
        if(ev.imagem) { preview.src = ev.imagem; preview.style.display = 'block'; } 
        else { preview.style.display = 'none'; }
        document.getElementById('imagemInput').value = '';

        // --- MAPA EDITAR ---
        modal.style.display = 'flex';
        iniciarMapa();
        if (ev.latitude && ev.longitude) {
            definirPonto(ev.latitude, ev.longitude);
            map.setView([ev.latitude, ev.longitude], 16);
        } else {
            resetarMapa();
        }
    };

    window.deletar = async function(id) {
        if(confirm('Tem certeza?')) {
            await fetch(`/api/eventos/${id}`, { method: 'DELETE' });
            carregar();
        }
    };

    document.getElementById('imagemInput').onchange = evt => {
        const [file] = evt.target.files;
        if (file) {
            const preview = document.getElementById('previewImagem');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    };

    inputBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.querySelectorAll('#tabelaCorpo tr').forEach(linha => {
            linha.style.display = linha.innerText.toLowerCase().includes(termo) ? '' : 'none';
        });
    });

    window.abrirModal = () => {
        form.reset();
        document.getElementById('eventoId').value = '';
        document.getElementById('modalTitulo').innerText = 'Novo Evento';
        document.getElementById('previewImagem').style.display = 'none';
        modal.style.display = 'flex';
        
        iniciarMapa();
        resetarMapa();
    };

    window.fecharModal = () => modal.style.display = 'none';

    carregar();
</script>